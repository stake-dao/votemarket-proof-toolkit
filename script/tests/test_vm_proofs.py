import pytest
from ape import accounts
from eth_utils import to_checksum_address


# Using test values to match with previous prod proofs and votes on Votemarket v1 : https://github.com/stake-dao/votemarket-data/blob/main/bounties/x-chain/1723680000/

PERIOD = 1723680000
BLOCK_NUMBER = 20530737
BLOCK_TIMESTAMP = 1723685159

VOTER = to_checksum_address("0x52f541764e6e90eebc5c21ff570de0e2d63766b6".lower())


@pytest.mark.asyncio
async def test_block_header(vm_proofs, setup_environment, oracle, whale):
    votemarket = setup_environment["votemarket"]
    campaign = votemarket.getCampaign(setup_environment["campaign1_id"])
    gauge_address = campaign[1]

    print("Gauge address:", gauge_address)

    # First, block data and header to oracle
    block_info = vm_proofs.get_block_info(BLOCK_NUMBER)

    # Data : https://github.com/stake-dao/votemarket-data/blob/main/bounties/x-chain/1723680000/block_header.json
    assert block_info["BlockNumber"] == BLOCK_NUMBER, "Block number should match"
    assert (
        block_info["BlockTimestamp"] == BLOCK_TIMESTAMP
    ), "Block timestamp should match"
    assert (
        block_info["BlockHash"]
        == "0xc8eada67a2c66e11ff9596628240fb4bccbd6aa039bc07256dc12a40d8430bcf"
    ), "Block hash should match"
    assert (
        block_info["RlpBlockHeader"]
        == "0xf90257a00f93f4a04ba5e0721a824c63b27648771871cccd7bce742a641f0c068ced6630a01dcc4de8dec75d7aab85b567b6ccd41ad312451b948a7413f0a142fd40d493479495222290dd7278aa3ddd389cc1e1d165cc4bafe5a0c40a51066f8d36749763611a9fc87de19e778d60b4555be33cb0d0c051663587a0102a043268a245ef4c7b50b1d4d81d8961d617d3c6eb7fc1517a1768eef96f51a07bfdcaf0668b54725447422d5cfe0777269e20ded93b11995426319412965a8eb9010015ad81697a1bd9c74e201994e6003101b39820108c8f6cb0433f420036228958044304680ada01122221324297cb69c943f9da309940e235f3df65228d6801905611bd8b50c8ef9bec7c5888904990a090824515426c482430f71585ac34c3043842522d6260043c1a0ac1bc2228edd726c007ac898f6e36c8244d7506090c4429e430502969c4d6c2c92b6623a40b418681b03145a082ea89a44142509b32718784288c1d973457066954c208828fc8260746209764320006280e3080282074d793450a905a1f6001094c5c5afb3c16324816aba74e853011025703d5bae19795fcb9f0468c262929072e865698ee26596cd700f39cb0c1a905b15ff0f534258084013946318401c9c38083fa4d0b8466bd59278f6265617665726275696c642e6f7267a0a640a7528ddbf0c4d321162d1fb321808bf4b62f15b10781e1fecf6ee4aa549a880000000000000000844142e2a2a08843e21b3de9054031a339d51ab4afef373bb2d1f559bb7981c0f251297416c48302000080a007b6926cb57c9857fbbeb48fff177d9432172c12247db1bdbf953aa47d483875"
    )

    # Insert in the oracle block info
    with accounts.use_sender(whale):
        oracle.insertBlockNumber(
            PERIOD,
            (
                block_info["BlockHash"],
                "0x0000000000000000000000000000000000000000000000000000000000000000",
                block_info["BlockNumber"],
                block_info["BlockTimestamp"],
            ),
        )

    # Assert the block in the oracle
    epoch_block_number = oracle.epochBlockNumber(PERIOD)

    # Assert the block hash
    assert (
        epoch_block_number[0].hex()
        == "0xc8eada67a2c66e11ff9596628240fb4bccbd6aa039bc07256dc12a40d8430bcf"
    ), "Block hash in oracle should match"

    # Assert the state root hash
    assert (
        epoch_block_number[1].hex()
        == "0x0000000000000000000000000000000000000000000000000000000000000000"
    ), "State root hash in oracle should match"

    # Assert the block number
    assert epoch_block_number[2] == BLOCK_NUMBER, "Block number in oracle should match"

    # Assert the timestamp
    assert (
        epoch_block_number[3] == BLOCK_TIMESTAMP
    ), "Block timestamp in oracle should match"


# TODO : Find a way to interact with the Verifier (now , all run indefinitely)
"""
def test_gauge_proof(vm_proofs, setup_environment, whale, oracle, verifier):
    votemarket = setup_environment["votemarket"]
    campaign = votemarket.getCampaign(setup_environment["campaign1_id"])
    gauge_address = campaign[1]

    with accounts.use_sender(whale):
        oracle.insertBlockNumber(
            1722470400,
            (
                "0x43973e985bbe65e6cb61447de305f0f82433bb0e1aaaf193a7dbcf51c02af448",
                "0x0000000000000000000000000000000000000000000000000000000000000000",
                20463250,
                1722871559,
            ),
        )

    verifier.setBlockData(
        "0xf9025ea002e6ffc397cb1f1989e20ab3855afaaba322be2baa038d2841a2509aed085bb0a01dcc4de8dec75d7aab85b567b6ccd41ad312451b948a7413f0a142fd40d49347944838b106fce9647bdf1e7877bf73ce8b0bad5f97a0a64e0f6fe0311e3d5825812e48782de4977800424e0f9945d1aa75620b5d6ef2a040842fd81f2c73562dc5a53f8b1bd59e73ecf2593c7529a0c62f4071a88c22ffa0a529b5d1270ffe984753b240017639e651e0bd7777efd9f9e84699e47f9706a6b9010053b37263ebad61cf726933609a89f7dc1385eb3ebc7b64607ee068936509a0b3a758c50dcab3da3e4e793f429e4f9f5db6bbe27c9aa138b597e4a46931ee6c808e28469c7e559e3f791ef509f28d396ba20d721e7c75baa67ff0f75f83764bf40c252f9083628ba2005f774102586da7e67b5c678730a46f57e2bbbca87b5278ef1df1ea0bd03d49e83da91093e263efeecbf6e3bb8d0a3ee62ea372489c4f28b7e149bb3ff83fc2632ff7c0fb0b3e8e17e7d6644e7ffb0c36f70d26272fdf64760258461542ef79576b2cec1c67b854c36d264fb76c955d779d15d6a8f5f732393ba84a852390be11c457ac497d1c1695aad32ac57e4fd84f0fdb7115dd5585808401383e928401c9c38083fca73a8466b0ef0798546974616e2028746974616e6275696c6465722e78797a29a022eeaabf44572330393ffe82e69c50b9fbae7f37a6c41d2e7e4ed00b27e8a2348800000000000000008507ca5bea77a0c37d4a3c8b6e8f43641c093e5f35feb9b585c49ff419f64622fd350fc6f712ad8080a0a13c096fa93d65603986dc3dd12860ddf4ef592665da389ba6dc2c3b94d1b98f",
        "0xf90e67f90211a0dddcf30df7261a9517ee1e3d5f089f91b649d2a99bc8e17fde621612b54cad5ea008dcfea581fe06b14e68dcc081da76cb44858d83e9db417eafcf878a0cc7af6fa032590287d4095454e900ce78a2634718fcd03df68e488b40f50d0f688548b2bfa0f36da89ec440b941ac26fa86979149d7d0a38bbfb91efe42fd1baf93c6f72602a0d889a6e7debf497d71d62b28b61ff4e95995404b8c6d4a24b7eb50cc54927808a0fcf34410031073483b356cf3b194799051961d816833936ad5f74a2d7a8ca006a08d9a06eeeb569c67a1797b7fc0a478c2b45381d14d18b142b891709b4764fc7ea0d74076a01e261bc6e009435083d4236748b90b1fae907e19450be0fb8b786b06a0eb5d3c4df8cc904045eff3a66d8b852b50b0a021f1707e0aece2c597c3b37bcca03736e34495900721d87ecf864e9caf194b4feef0680c864a399e62e5fc3f19a6a0eaff4c1e5ef87a1943bba63f9207ced0009d214c87b96492abf7f0a6958c6cb5a0f31cb0b7c5d9dfe5b49af7d68b2d94eeaeef950cebcb5a710410eeef7b496309a0b4f7f64ed019bc87d3de645a562df597c2060877e3033fc46d5d3537aa80eb89a066ea3fcc26128e754987b91cff7accaef591c5d60eac2f7db33823e0f4bbc555a021d73c14bf1c86837ce1868bc1c517fa490cb730d2e1ac939318c84d04d73f1aa0cd953120bb1fe6590c0d62cad9dcec172b81e5231725b17275685ccf5f88c4ad80f90211a04b10e0227f88265cc686f00748527c5b0b29093f2ae9a5c5fe491ecd15c1fcada0e433a11e17faef4a224da30fbdb387a466ba0b3f52f0703839367ecd36ce4930a0eb000477c09fd6427d09242b3e17e086d67a088ad88273fd6a5f16e951c92008a076c444951b09b581909b00532054f3b2d3abcf9216a1449ceb2150ce37620bd3a0f3430b0433b44f953e750f11d42056d896501b480e2645e0aedb3a1ccfe0244ba0ea25ffc89aafe5ee9ace7a9f3529b37a96c42302adadc6b104548d63f18b9174a049716c73178206e3a33fb83adf4701c43f2d2c8c1d76ad0a92895b004d74762ba0da2d534d8c37b0223388181a9f7ecd86f5dcfc44a7f25ccea1f58406f66d2472a07e7faf66e8a9a1e1a15635327e7d096ca26534879a24bb56d1bcfdc4eb420785a0661eb8659e03855a726bbcf0d71c7b763179d0133b07aa234e07106c594bd024a0f0b8795571201de3e237ec94ab102bb067ece078450cbc094ad6faa9861fa0cfa049aafbf6ac7f83b82e08ba42b5bc084f5c496be80b6925bb6a03a624d4310d51a0e69c32dd3a22b7a2d2a6fb0315fc434de49d8b19fad5919c4bdf8959f2be078ea02caf2a52cd80d923f5bbacebf1027aeee8a5ad4fc61c6594f8cb3d9235a0b3fea07a448d5be9f57b9ea446eb34113f25e222a1ea3ef7b6685ad025c36016e547d7a0af1e57249b20a5c2983274b09d15794be81ee093acf642897e48a75056933fd080f90211a07540b038c96c1743130afd1381a9494161cb27dfe15bd01c7ef79f54c7584579a07906a0126d2dfe5bf833fda9e3a3ebdbeac948c39a43f0977f7ce6a1684f9163a0dddbc849f33f579d42d823d81e22be7bb3833307b32742aa2840332a999050e1a09ec8be32d406e0d501ea74d73a30108aa620989e2a8c91af66527a31d5171c34a00582e0b63ae2b573baed72794d572833294ba98c467ee2a5687f8e312ce994d6a0894cba839fe6f63f1a4413073a2695eec685d74967ce6caed860e70b9f09a430a044f7431e509cc0669a846c25b3dc0ff37516bb7c5b2a7b43ec6371288c763e43a0d78e7d5cd5c8a18f243a84164ac41d9319cb4ef1e07fba4caf6eb31dc452fc2da0a6ce9a1ef8a727869ac237f7fdedc4621036e987420be1eedf46c651dc1c8e20a0092b4c69509b161803e3d5febb64fff423e35b0a91e9bac8bcb443f53a575a4da0729fe328f724a90f519213ac5c4fde019890eebf9b017627463be2c3efeb2e1aa056db7578998b9ffaadd822164ef3c1368088173c9f7b7d55ba01f3a725a57077a0a2eb2b88e7d3b2b1929bc5a013b1e7de35cdd454601b1e16b1dc73607d1f3bb2a0eae6eb5d9f8199b11edf6c4a353ae91a75b94b6422b1b9efb3f9525991026764a08c69b00c812c6b8aa2aa60a7e75882f0651df7a9b05b5ab7e3183fec594fe359a0873f2e76ce593aef690de9164bb22d40c5bb07024b86732b2f4c7c8be849757880f90211a0858d356e685641cc598a5ed476da446dbdbc7c7178314388d3f9e18dd3cecfd6a06fde793873666812b22c14652fefaf1858986fd11986dfd2632e99c0cf8ffe1ca0de5fd8d4befed062efad849392115e34bd3a4fed2eee9671c124f6ec8f756e61a0af84e8a7d037dc94951433fb949bf68e15571af4af573b97cb096ee0cc62bd63a01b63c9a5440aee25b7f00012512559de799ba3e8120748612ca8ae5dcc9b65e9a0f745aa823c9b839abd2b4dbd217e69c4a6c7b739e30953d67f9c2f9660c24f55a06ec8b92952a9745e38f3ae05a595f9e81648e512078f04a94f88f981434e853ca040cb0914931e8564586a704ef873c495cfa3d053b38b57d0f96cc73a77e40ed1a0f7d080e52ef8eca2e340b234f71551a2ec3f4415ea7dac5af39cf62f394ceb90a048399064919c8dd9f978389fc1a79ed6de99b7878dcac3f6bfe4e5f1804b7030a01eafd9fed3c0f58d93f91975cb1eb97a2146ae51835cf3e43919219a5fcb2557a0daa98faf47ebfde8b18652455d7baa70203db6818364e442d14ab32da73f24c5a0ade0bb5f1959364a2ca7897abc9b4ea3645489a427d4a6a964f10bae67ee7546a0f211bd65b638d0cbd7902c6397bbc3cb84cbcb178865fc224b9457ac415a2183a07aed72ff82ba5e2dde8226120b3d7b25b6781404695b8ca3e89780b05517da29a0fd63dc5dc02036bcdf1597249fd4b450c473add27e5cbbae79cc5ee42755ba6380f90211a0859d3db30d3ec02da2b393a58eaa2b90553c1db757da2867f9be8c73425a8032a0aaf1a5f29e2b84a527ddda1d66b1115a70a2dba4997928a4cd66c85ec95b5faea0f9ef4a9ba76176b0b12ab0611e9ae791e8d5de28a9c07fbdf483141a50f9a9a4a04b03923f1eadd2ee5084c84bd534ea76b845b27090e20e070447cdb7cfdac44fa0f164527b4b56c547f28d4cd23c80e088e352b4e23d1a41e4969fde6cd17ffbcaa09bfb258ec0b706f58d7b4fce33010a311e7d1e1b0efcff3196b0d0398de5e4d2a00342027464c6218f886d8fa50bd6d04217b4b8d84d269eee551fbcf8efdc2ccfa08ebef303857cdbc797bfce825c386072a99ebda0a3df1752bd3178c58b1b2dd4a0b2608b6d79b761cc427bf019d0a60bd8e14f3f9d9b16e0337f3559d1acc47035a00cf479829f07abb2cce6dd4dae14d87436048d0b6305fc4b6bd262a53f2d52f7a053f728ebcc7522a85255f23f95441fc99bc5d91777909eb4f988f9aba18fc63da00ef85849eba7401f1d0c44c7c1dfbb1ddfbefc7908ea0a056379a5965805e981a03e4c6285fd6a6227dd322ea38107349ceb30a6ef600326f4b3140bad63da089ba08c95fa3748c76fe589e8159ecd409ade18d5f44edd65e1d8f35533166fa54e0ea0ae2b6fe397399d0cd9b2a576fa9b5fdb11f7b4416b3cc44823d829cabb9609d1a01627fd0f4f2953ceefe97c0ecefe95acb71074fc0c8b64e934f1ec5fc46c470c80f90211a070dfdeab96ce9a00f54b57b4422fcfe1f9947236055572f3bf55fff40cd4037fa0a73aeaf1a914b76b49075ce0407e4d25aa00e6c989dbf489ce125da4dd104383a0450ac49ce1e266efa6a6a2fe687e3a64cc2ef2a8ecf9121294b471b993d20f35a002e111c88f4d67fb880bb2f8f3f409184a29ac17668bff2aa16541fd698ed887a0ff4e2059363ddb7d671d43345fa8a2e1b527c203d4e86a294e158301c8db2784a015ef5ed9c36a186aa2d20387abec357f3d0ced918758560f3b462186ffe93a13a077bb77043a2976f26ef1cdd8552e46a007240d09f301d40829ba0c4396a55737a0304ea31b9a63c61c66ff35a4e400cb4116b20b31e4426fe332d0ee1ba01497d1a087349c4b7dd79b210c3a93be150fb647607e48636e023a713081e2b710b3757da02f236ddd8396c2bd02d833f3c7995acf443b36537c93f26cdca748e549f25a82a038fef8c86d2eceb56a75475b80e8df6957e605105bbabba1500dac411e9f7107a0bed2f962bed3a1dd7f6ccf811579e328cd2493685f6b715c5ccd85b8a5dd03a5a0ba9a6f5f9470f45628d747468996176065e9d2d2bdebde78881212cfec71b155a09eea4d94c1afff929734e39d5f0e22195fc8196e426168aa9c07713f6bda7c57a0315ff16261b8be6215a359307a6d6ec36268d6614ef709f076fb3388c3649f87a0e8ec9809a7a76efebd9da4a7087c322a0e2af1f3e4e0b052c284529d85ba936680f901318080a0c04ecc6ad57490bd0bebebde18a81dbb6d05bb90ae63d79bb5e68030d91e569980a0f1d2aa4db07bedfe0f0149afade7a31bdeac77397fef95f0017e0973c3965b7980a07d62b383908cf6fd1e92379573fadbcd4a1e8aa88375b86954b3ca2788eb646fa09f8e2ee438ed090ba1ef20217617e5f87220383a485438bfbdf76699bf080ca4a00bdb2f3d8c81de151c28a001ad2c765f1a4e38318fe717f32389394e799d8879a0a16ae8625080e3c89b74c290d29c26991e664a266d50b3e800f26fa4c38d46b3a07259ea895d12daa67a1674487ae7edcbd4270c8e8fe402eb93334b09f2682bd5a0cfed3c48404dbbf22b9403fe4b9fbc4ee2062081f459760ff9c6611faed26a2680a0e1768f462462ef1625eefede5d3cb80a5592eef7bc9a815f36f24ca6bbfe82d4808080f8518080a049f944854708eaeb28ae36cf73edc039770bd1f3d2f7dd8da23fca2a04d3f1578080808080808080808080a0889327722d3675800d695f7a6d82ff0d4caedc7dfc565b30431bd1595df415138080f8669d2051d27564f387adf7af9e9a5a8195d11b3334b010b8a70766e9dcc32bb846f8440180a01b3a93305169db7456af4064f5a61111ba49b3b99eb127333236cad42dcb7a05a0655bec9519bc4e87c56bb2c54767c5ae6407f8be1b29140f5110c29d9607d42d",
        sender=whale.address,
    )
"""
